import React, { useEffect, useRef, useState } from 'react';

const MapComponent: React.FC = () => {
  const mapRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const [mapInstance, setMapInstance] = useState<google.maps.Map | null>(null);

  useEffect(() => {
    const initMap = async () => {
      if (window.google && mapRef.current && inputRef.current) {
        try {
          // 1. Import Libraries
          const { Map } = await google.maps.importLibrary("maps") as google.maps.MapsLibrary;
          const { Autocomplete } = await google.maps.importLibrary("places") as google.maps.PlacesLibrary;
          const { AdvancedMarkerElement } = await google.maps.importLibrary("marker") as google.maps.MarkerLibrary;

          // 2. Initialize Map
          const map = new Map(mapRef.current, {
            center: { lat: 45.5017, lng: -73.5673 },
            zoom: 12,
            mapId: "DEMO_MAP_ID", // Change to your Map ID
          });
          setMapInstance(map);

          // 3. Initialize Search Bar (Autocomplete)
          const autocomplete = new Autocomplete(inputRef.current, {
            fields: ["geometry", "name", "formatted_address"],
            types: ["address"], // You can change this to ['(regions)'] for zip codes only
          });

          // 4. Bind Search to Map
          autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();

            if (!place.geometry || !place.geometry.location) {
              window.alert("No details available for input: '" + place.name + "'");
              return;
            }

            // Move map to the new location
            if (place.geometry.viewport) {
              map.fitBounds(place.geometry.viewport);
            } else {
              map.setCenter(place.geometry.location);
              map.setZoom(17);
            }

            // Optional: Drop a marker at the searched location
            new AdvancedMarkerElement({
              map: map,
              position: place.geometry.location,
              title: place.name,
            });
          });

        } catch (error) {
          console.error("Error loading Google Maps/Places:", error);
        }
      }
    };

    initMap();
  }, []);

  return (
  <div className="w-full h-[500px] rounded-xl overflow-hidden shadow-lg border border-slate-200">
    <div 
      ref={mapRef} 
      style={{ width: '100%', height: '500px' }} // Height must be explicit
    />
  </div>
);

      {/* Map Container */}
      <div ref={mapRef} className="w-full h-full" />
    </div>
  );
};

export default MapComponent;
