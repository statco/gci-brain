import React, { useEffect, useRef, useState } from 'react';

interface Installer {
  id: string;
  name: string;
  address: string;
  city: string;
  province: string;
  coordinates?: {
    lat: number;
    lng: number;
  };
  distance?: number;
}

interface MapComponentsProps {
  installers: Installer[];
  mapsLoaded?: boolean;
}

const MapComponents: React.FC<MapComponentsProps> = ({ installers, mapsLoaded }) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const [mapInstance, setMapInstance] = useState<google.maps.Map | null>(null);
  const markersRef = useRef<google.maps.marker.AdvancedMarkerElement[]>([]);
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    // Wait for both the DOM ref and Google Maps to be ready
    if (!mapRef.current || !window.google) {
      console.log('Waiting for map container or Google Maps...');
      return;
    }

    const initMap = async () => {
      try {
        console.log('üó∫Ô∏è Initializing map with', installers.length, 'installers');
        
        // Use the new importLibrary pattern
        const { Map } = await google.maps.importLibrary("maps") as google.maps.MapsLibrary;
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker") as google.maps.MarkerLibrary;

        let currentMap = mapInstance;
        
        if (!currentMap) {
          currentMap = new Map(mapRef.current!, {
            center: { lat: 48.2368, lng: -79.0228 },
            zoom: 11,
            mapId: 'gci-installers-map',
            disableDefaultUI: false,
            clickableIcons: false,
          });
          setMapInstance(currentMap);
          console.log('‚úÖ Map instance created');
        }

        // Clear old markers
        markersRef.current.forEach(m => m.map = null);
        markersRef.current = [];
        
        // Add markers for installers with valid coordinates
        const validInstallers = installers.filter(inst => 
          inst.coordinates && 
          !isNaN(inst.coordinates.lat) && 
          !isNaN(inst.coordinates.lng)
        );

        console.log('üìç Creating', validInstallers.length, 'markers');

        markersRef.current = validInstallers.map(inst => {
          const markerElement = document.createElement('div');
          markerElement.innerHTML = `
            <div style="
              background: #ef4444;
              color: white;
              padding: 8px 12px;
              border-radius: 20px;
              font-weight: 600;
              font-size: 14px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.3);
              cursor: pointer;
              white-space: nowrap;
            ">
              üìç ${inst.name}
            </div>
          `;

          return new AdvancedMarkerElement({
            map: currentMap,
            position: inst.coordinates!,
            content: markerElement,
            title: inst.name,
          });
        });

        // Fit bounds to show all markers
        if (markersRef.current.length > 0) {
          const bounds = new google.maps.LatLngBounds();
          validInstallers.forEach(inst => {
            bounds.extend(inst.coordinates!);
          });
          currentMap.fitBounds(bounds);
          
          // Set max zoom
          google.maps.event.addListenerOnce(currentMap, 'bounds_changed', () => {
            const zoom = currentMap!.getZoom();
            if (zoom && zoom > 13) {
              currentMap!.setZoom(13);
            }
          });
        }

        setIsReady(true);
        console.log('‚úÖ Map setup complete');

      } catch (err) {
        console.error("‚ùå Map initialization error:", err);
      }
    };

    // Add small delay to ensure DOM is ready
    const timer = setTimeout(() => {
      initMap();
    }, 100);

    return () => clearTimeout(timer);
  }, [installers, mapInstance]);

  if (!window.google) {
    return (
      <div className="w-full h-full flex items-center justify-center bg-slate-900 rounded-xl">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-slate-400">Loading Google Maps...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="w-full h-full rounded-xl overflow-hidden border border-slate-200 shadow-lg">
      <div ref={mapRef} className="w-full h-full min-h-[500px]" />
    </div>
  );
};

export default MapComponents;
