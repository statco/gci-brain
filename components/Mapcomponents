import React, { useEffect, useRef } from 'react';

interface MapComponentsProps {
  installers: any[];
  mapsLoaded: boolean;
}

const MapComponents: React.FC<MapComponentsProps> = ({ installers, mapsLoaded }) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<google.maps.Map | null>(null);

  useEffect(() => {
    // Only initialize if the API is loaded and the container exists
    if (!mapsLoaded || !mapRef.current || !window.google) return;

    const initMap = async () => {
      try {
        const { Map } = await google.maps.importLibrary("maps") as google.maps.MapsLibrary;
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker") as google.maps.MarkerLibrary;

        // If map doesn't exist, create it
        if (!mapInstanceRef.current) {
          mapInstanceRef.current = new Map(mapRef.current!, {
            center: { lat: 48.2368, lng: -79.0228 }, // Center on Rouyn-Noranda
            zoom: 10,
            mapId: "DEMO_MAP_ID", // REQUIRED for Advanced Markers. Use "DEMO_MAP_ID" for testing.
            mapTypeControl: false,
            streetViewControl: false,
            background: '#0a0e1a'
          });
        }

        // Add markers for the 3 installers found in your logs
        installers.forEach((inst) => {
          if (inst.coordinates && !isNaN(inst.coordinates.lat)) {
            new AdvancedMarkerElement({
              map: mapInstanceRef.current,
              position: inst.coordinates,
              title: inst.name,
            });
          }
        });

      } catch (error) {
        console.error("Map Initialization Error:", error);
      }
    };

    initMap();
  }, [installers, mapsLoaded]);

  return (
    <div className="w-full h-full min-h-[500px] rounded-3xl overflow-hidden border border-white/10 shadow-inner bg-[#0a0e1a]">
      <div 
        ref={mapRef} 
        style={{ width: '100%', height: '100%', minHeight: '500px' }} 
      />
    </div>
  );
};

export default MapComponents;
